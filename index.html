<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¤é£²æˆæœ¬ç²¾ç®—å¤§å¸« SmartCost (æ——è‰¦V3.9ç‰ˆ)</title>
  
  <!-- å…¨å±€éŒ¯èª¤æ””æˆª -->
  <script>
    window.onerror = function(msg, url, line, col, error) {
      const errorBox = document.getElementById('error-box');
      if (errorBox) {
        errorBox.style.display = 'block';
        document.getElementById('error-message').innerText = `ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š\n${msg}\n(è¡Œæ•¸: ${line})`;
      }
      return false;
    };
  </script>

  <!-- è¼‰å…¥ React æ ¸å¿ƒ -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script>window.react = window.React;</script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide-react@0.300.0/dist/umd/lucide-react.js"></script>

  <style>
    body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .unit-weight { background-color: #fef9c3; border-color: #fde047; color: #854d0e; }
    .unit-qty { background-color: #dcfce7; border-color: #86efac; color: #166534; }
    .sortable-header { cursor: pointer; user-select: none; transition: background 0.2s; }
    .sortable-header:hover { background-color: #f1f5f9; }

    /* ä¸»è‰²èª¿ - æ·±æ©™è‰² */
    .bg-brand { background-color: #ff8c00; }
    .bg-brand:hover { background-color: #e07b00; }
    .text-brand { color: #ff8c00; }
    .border-brand { border-color: #ff8c00; }
    .ring-brand:focus { --tw-ring-color: #ff8c00; }
    .bg-brand-light { background-color: #fff7ed; }
    
    .input-disabled { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
    
    /* å¯ç·¨è¼¯å–®å…ƒæ ¼æ¨£å¼ */
    .editable-cell-wrapper {
        border-bottom: 1px dashed transparent;
    }
    .editable-cell-wrapper:hover::after {
        content: 'âœ';
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        color: #cbd5e1;
    }
    .editable-cell-wrapper:hover {
        background-color: #fffbeb; /* amber-50 */
        border-radius: 4px;
        box-shadow: 0 0 0 1px #fcd34d;
        cursor: text;
        border-bottom-color: #fcd34d;
    }
  </style>
</head>
<body class="bg-gray-100">
  
  <div id="error-box" style="display:none; position:fixed; top:20px; left:20px; right:20px; background:#fee2e2; border:2px solid #ef4444; color:#b91c1c; padding:20px; z-index:9999; border-radius:8px;">
    <h3 style="font-weight:bold;">âš ï¸ ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</h3>
    <pre id="error-message"></pre>
    <button onclick="document.getElementById('error-box').style.display='none'" style="margin-top:10px; padding:5px 15px; background:#dc2626; color:white; border:none; rounded:4px;">é—œé–‰</button>
  </div>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;
    
    // --- Icons ---
    const Icons = window.lucideReact || {};
    const getIcon = (name, fallbackEmoji) => {
      const IconComp = Icons[name];
      return IconComp || (() => <span style={{fontSize: '1.2em', lineHeight: 1}}>{fallbackEmoji}</span>);
    };

    const Calculator = getIcon('Calculator', 'ğŸ§®');
    const Package = getIcon('Package', 'ğŸ“¦');
    const Utensils = getIcon('Utensils', 'ğŸ´');
    const TrendingUp = getIcon('TrendingUp', 'ğŸ“ˆ');
    const Save = getIcon('Save', 'ğŸ’¾');
    const Trash2 = getIcon('Trash2', 'ğŸ—‘ï¸');
    const Plus = getIcon('Plus', 'â•');
    const Edit3 = getIcon('Edit3', 'âœï¸');
    const Download = getIcon('Download', 'â¬‡ï¸');
    const Upload = getIcon('Upload', 'â¬†ï¸');
    const AlertCircle = getIcon('AlertCircle', 'âš ï¸');
    const DollarSign = getIcon('DollarSign', 'ğŸ’²');
    const Search = getIcon('Search', 'ğŸ”');
    const Layers = getIcon('Layers', 'ğŸ“š');
    const Bike = getIcon('Bike', 'ğŸ›µ');
    const FileSpreadsheet = getIcon('FileSpreadsheet', 'ğŸ“Š');
    const LayoutGrid = getIcon('LayoutGrid', 'ç”°');
    const List = getIcon('List', 'â˜°');
    const Table = getIcon('Table', 'â–¦');
    const ArrowUpDown = getIcon('ArrowUpDown', 'â‡…');
    const Users = getIcon('Users', 'ğŸ‘¥'); 
    const Link2 = getIcon('Link2', 'ğŸ”—'); 
    const Lock = getIcon('Lock', 'ğŸ”’');
    const Unlock = getIcon('Unlock', 'ğŸ”“');
    const Smartphone = getIcon('Smartphone', 'ğŸ“±');
    const Monitor = getIcon('Monitor', 'ğŸ’»');
    const Menu = getIcon('Menu', 'â˜°'); 
    const X = getIcon('X', 'âœ•'); 
    const Droplets = getIcon('Droplets', 'ğŸ’§');
    const BarChart3 = getIcon('BarChart3', 'ğŸ“Š');
    const PieChart = getIcon('PieChart', 'ğŸ¥§');

    // --- Constants ---
    const CATEGORIES = ['è‚‰æµ·é®®é¡', 'è”¬æœé¡', 'åŠæˆå“é¡', 'èª¿å‘³æ–™é¡', 'åŒ…æé¡', 'çµ„åˆææ–™'];

    const isWeightUnit = (unit) => {
      const weights = ['g', 'kg', 'ml', 'l', 'cc', 'å…¬å…‹', 'å…¬æ–¤', 'å°æ–¤', 'oz', 'lb'];
      return weights.includes(unit?.toLowerCase());
    };
    
    // --- é€šç”¨å¯ç·¨è¼¯å–®å…ƒæ ¼çµ„ä»¶ ---
    const EditableCell = ({ value, type = 'text', options = [], onSave, className = '', suffix = '' }) => {
        const [editing, setEditing] = useState(false);
        const [temp, setTemp] = useState(value);

        useEffect(() => setTemp(value), [value]);

        const commit = () => {
            if (temp != value) { // Use loose equality for string/number diff
                onSave(type === 'number' ? parseFloat(temp) : temp);
            }
            setEditing(false);
        };

        if (editing) {
            if (type === 'select') {
                return (
                    <select 
                        autoFocus 
                        value={temp} 
                        onChange={e => setTemp(e.target.value)} 
                        onBlur={commit} 
                        className="w-full p-1 border border-brand outline-none rounded text-sm bg-white shadow-lg min-w-[60px]"
                    >
                        {options.map(opt => (
                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                        ))}
                    </select>
                );
            }
            return (
                <input
                    autoFocus
                    type={type}
                    value={temp}
                    onChange={e => setTemp(e.target.value)}
                    onBlur={commit}
                    onKeyDown={e => e.key === 'Enter' && commit()}
                    className="w-full p-1 border border-brand outline-none rounded text-sm shadow-inner min-w-[60px]"
                    step={type === 'number' ? 'any' : undefined}
                />
            );
        }

        return (
            <div 
                onClick={() => setEditing(true)} 
                className={`editable-cell-wrapper relative px-1 py-0.5 transition-all ${className}`}
                title="é»æ“Šå³å¯ç·¨è¼¯"
            >
                {type === 'select' 
                    ? (options.find(o => o.value == value)?.label || value || <span className="text-slate-300 italic">ç„¡</span>) 
                    : (value || <span className="text-slate-300 italic">-</span>)
                }{suffix}
            </div>
        );
    };

    const SmartCostApp = () => {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [mobileMode, setMobileMode] = useState(false);
      const [isSidebarOpen, setIsSidebarOpen] = useState(false);
      
      const md = (classes) => mobileMode ? '' : classes;

      // è‡ªå‹•åµæ¸¬è¢å¹•å¯¬åº¦
      useEffect(() => {
        const checkMobile = () => {
          if (window.innerWidth < 768) {
            setMobileMode(true);
          }
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // --- Data State ---
      const initialVendors = [{ id: 1, name: 'å¥½å¸‚å¤š', contact: 'å®¢æœ', phone: '', note: '' }];
      const initialIngredients = [
        // æ³¨æ„ï¼šç‚ºäº†æ”¯æ´ç›´è¦ºç·¨è¼¯é€£å‹•ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ inputAmount å’Œ inputUnit å­˜åœ¨
        { id: 1, name: 'è±¬äº”èŠ±', price: 900, unit: 'g', amount: 3000, inputAmount: 3, inputUnit: 'kg', note: '3kg $900', category: 'è‚‰æµ·é®®é¡', vendorId: 1, yieldRate: 100 },
        { id: 2, name: 'è’œé ­', price: 150, unit: 'g', amount: 600, inputAmount: 600, inputUnit: 'g', note: '600g $150', category: 'è”¬æœé¡', vendorId: '', yieldRate: 95 }, 
        { id: 3, name: 'ç´™ç¢—', price: 200, unit: 'å€‹', amount: 50, inputAmount: 50, inputUnit: 'å€‹', note: '50å€‹ $200', category: 'åŒ…æé¡', vendorId: '', yieldRate: 100 },
        { id: 4, name: 'æ´—é¸è›‹', price: 8, unit: 'é¡†', amount: 1, inputAmount: 1, inputUnit: 'é¡†', note: '1é¡† $8', category: 'è‚‰æµ·é®®é¡', vendorId: '', yieldRate: 100 },
      ];
      const initialRecipes = [
        { id: 1, name: 'è’œæ³¥ç™½è‚‰', sellingPrice: 200, items: [{ ingredientId: 1, usage: 250 }, { ingredientId: 2, usage: 10 }], deliveryRate: 32, deliveryPrice: 220 }
      ];

      const [vendors, setVendors] = useState(() => JSON.parse(localStorage.getItem('sc_v39_vendors')) || initialVendors);
      const [ingredients, setIngredients] = useState(() => {
        const d = JSON.parse(localStorage.getItem('sc_v39_ing')) || initialIngredients;
        // Migration check: ensure inputAmount exists
        return d.map(i => ({
            ...i, 
            sourceRecipeId: i.sourceRecipeId || null,
            inputAmount: i.inputAmount || (i.unit === 'g' ? i.amount / 1000 : i.amount), // Simple fallback guess
            inputUnit: i.inputUnit || (i.unit === 'g' ? 'kg' : i.unit) // Simple fallback guess
        })); 
      });
      const [recipes, setRecipes] = useState(() => JSON.parse(localStorage.getItem('sc_v39_rec')) || initialRecipes);
      const [sets, setSets] = useState(() => JSON.parse(localStorage.getItem('sc_v39_sets')) || []);
      const [targetMargin, setTargetMargin] = useState(() => Number(localStorage.getItem('sc_v39_margin')) || 50);
      const [salesData, setSalesData] = useState(() => JSON.parse(localStorage.getItem('sc_v39_sales')) || {});

      useEffect(() => localStorage.setItem('sc_v39_vendors', JSON.stringify(vendors)), [vendors]);
      useEffect(() => localStorage.setItem('sc_v39_ing', JSON.stringify(ingredients)), [ingredients]);
      useEffect(() => localStorage.setItem('sc_v39_rec', JSON.stringify(recipes)), [recipes]);
      useEffect(() => localStorage.setItem('sc_v39_sets', JSON.stringify(sets)), [sets]);
      useEffect(() => localStorage.setItem('sc_v39_margin', targetMargin), [targetMargin]);
      useEffect(() => localStorage.setItem('sc_v39_sales', JSON.stringify(salesData)), [salesData]);

      // --- Calculations ---
      const getUnitCost = (ing) => {
        if (!ing) return 0;
        if (ing.sourceRecipeId) {
          const sourceRecipe = recipes.find(r => r.id === ing.sourceRecipeId);
          if (sourceRecipe) {
            const recipeTotalCost = calculateRecipeCostRecursive(sourceRecipe.items);
            return ing.amount > 0 ? recipeTotalCost / ing.amount : 0;
          }
        }
        if (!ing.amount) return 0;
        const baseCost = ing.price / ing.amount;
        const yieldRate = (ing.yieldRate || 100) / 100;
        return yieldRate > 0 ? baseCost / yieldRate : baseCost;
      };

      const calculateRecipeCostRecursive = (items) => {
        return items.reduce((total, item) => {
          const ing = ingredients.find(i => i.id === Number(item.ingredientId));
          return total + (ing ? getUnitCost(ing) * item.usage : 0);
        }, 0);
      };

      const calcRecipeCost = (items) => calculateRecipeCostRecursive(items);

      const calcRecipeDisplay = (items) => {
        let totalWeight = 0;
        let otherCounts = [];
        items.forEach(item => {
          const ing = ingredients.find(i => i.id === Number(item.ingredientId));
          if (!ing || ing.category === 'åŒ…æé¡') return; 
          if (isWeightUnit(ing.unit)) {
            totalWeight += parseFloat(item.usage) || 0;
          } else {
            otherCounts.push(`${item.usage}${ing.unit}`);
          }
        });
        let output = totalWeight > 0 ? `${totalWeight.toFixed(1)}g` : '';
        if (otherCounts.length > 0) {
          output += (output ? ' + ' : '') + otherCounts.join(' + ');
        }
        return output || '0g';
      };
      
      const calcRecipePureWeight = (items) => {
        return items.reduce((total, item) => {
          const ing = ingredients.find(i => i.id === Number(item.ingredientId));
          if (!ing || ing.category === 'åŒ…æé¡' || !isWeightUnit(ing.unit)) return total;
          return total + (parseFloat(item.usage) || 0);
        }, 0);
      }

      const downloadFile = (content, filename) => {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      };

      // --- Components ---
      const MarginBadge = ({ val }) => (
        <span className={`font-bold ${val < targetMargin ? 'text-red-500' : 'text-emerald-500'}`}>
          {val.toFixed(1)}%
        </span>
      );

      // --- Sidebar Component ---
      const Sidebar = () => (
        <>
          {mobileMode && isSidebarOpen && (
            <div className="fixed inset-0 bg-black/50 z-40" onClick={() => setIsSidebarOpen(false)} />
          )}

          <div className={`
            bg-slate-900 text-slate-100 p-4 flex flex-col gap-2 shadow-xl z-50 overflow-y-auto shrink-0 transition-all duration-300
            ${mobileMode 
              ? `fixed inset-y-0 left-0 w-64 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}` 
              : 'w-full md:w-64 relative translate-x-0'
            }
          `}>
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-xl font-bold flex items-center gap-2 text-brand">
                <Calculator /> ç²¾ç®—å¤§å¸« <span className="text-xs bg-brand text-white px-1 rounded">V3.9</span>
              </h1>
              {mobileMode && (
                <button onClick={() => setIsSidebarOpen(false)} className="text-slate-400 hover:text-white">
                  <X size={24}/>
                </button>
              )}
            </div>

            {[
              { id: 'dashboard', icon: TrendingUp, label: 'ç¸½è¦½åˆ†æ' },
              { id: 'vendors', icon: Users, label: 'å» å•†ç®¡ç†' },
              { id: 'ingredients', icon: Package, label: 'åŸæ–™ç®¡ç†' },
              { id: 'recipes', icon: Utensils, label: 'å–®å“/é…æ–¹' },
              { id: 'sets', icon: Layers, label: 'å¥—é¤ç®¡ç†' },
              { id: 'projection', icon: BarChart3, label: 'ç‡Ÿæ”¶é ä¼° (æ–°!)' }
            ].map(tab => (
              <button key={tab.id} onClick={() => { setActiveTab(tab.id); if(mobileMode) setIsSidebarOpen(false); }} 
                className={`p-3 rounded-lg flex items-center gap-3 transition-colors ${activeTab === tab.id ? 'bg-brand text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300'}`}>
                <tab.icon size={20} /> {tab.label}
              </button>
            ))}
            
            <div className="mt-auto pt-4 border-t border-slate-700 space-y-2">
              <button onClick={() => { setMobileMode(!mobileMode); setIsSidebarOpen(false); }} 
                className={`w-full p-2 rounded text-xs flex items-center justify-center gap-2 font-bold transition-colors ${mobileMode ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
                {mobileMode ? <><Monitor size={14}/> åˆ‡æ›å›é›»è…¦ç‰ˆ</> : <><Smartphone size={14}/> åˆ‡æ›æ‰‹æ©Ÿæ’ç‰ˆ</>}
              </button>

              <div className="text-xs text-slate-400 font-bold mb-1 mt-2">å…¨ç³»çµ±å‚™ä»½ (JSON)</div>
              <button onClick={() => {
                 const blob = new Blob([JSON.stringify({ ingredients, recipes, sets, vendors, targetMargin, salesData })], { type: 'application/json' });
                 const a = document.createElement('a');
                 a.href = URL.createObjectURL(blob);
                 a.download = `smartcost_backup_v3.9_${new Date().toISOString().slice(0,10)}.json`;
                 a.click();
              }} className="w-full p-2 bg-slate-800 hover:bg-slate-700 rounded text-xs flex items-center justify-center gap-2 border border-slate-600">
                 <Download size={14} /> å‚™ä»½è³‡æ–™åº«
              </button>
              <label className="w-full p-2 bg-slate-800 hover:bg-slate-700 rounded text-xs flex items-center justify-center gap-2 cursor-pointer border border-slate-600">
                 <Upload size={14} /> é‚„åŸè³‡æ–™åº«
                 <input type="file" className="hidden" accept=".json" onChange={(e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                      try {
                        const d = JSON.parse(ev.target.result);
                        if(d.ingredients) setIngredients(d.ingredients);
                        if(d.recipes) setRecipes(d.recipes);
                        if(d.sets) setSets(d.sets);
                        if(d.vendors) setVendors(d.vendors);
                        if(d.targetMargin) setTargetMargin(d.targetMargin);
                        if(d.salesData) setSalesData(d.salesData);
                        alert('è³‡æ–™åº«é‚„åŸæˆåŠŸï¼');
                      } catch(err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
                      e.target.value = '';
                    };
                    reader.readAsText(file);
                 }} />
              </label>
            </div>
          </div>
        </>
      );

      const IngredientsView = () => {
        const [isEditing, setIsEditing] = useState(null);
        const [form, setForm] = useState({ 
          name: '', category: 'è‚‰æµ·é®®é¡', price: '', 
          inputAmount: '', inputUnit: 'kg', calcUnit: 'g',
          vendorId: '', yieldRate: 100 
        });
        const [filterCat, setFilterCat] = useState('ALL');

        useEffect(() => {
          const wUnits = ['kg', 'å°æ–¤', 'lb'];
          if (wUnits.includes(form.inputUnit)) setForm(f => ({...f, calcUnit: 'g'}));
          else if (['L'].includes(form.inputUnit)) setForm(f => ({...f, calcUnit: 'ml'}));
          else setForm(f => ({...f, calcUnit: form.inputUnit}));
        }, [form.inputUnit]);

        // --- æ ¸å¿ƒé‚è¼¯ï¼šç›´è¦ºç·¨è¼¯ä¸¦é€£å‹•æ›´æ–° (Key Logic) ---
        const updateIngredient = (id, updates) => {
            setIngredients(prev => prev.map(ing => {
                if (ing.id !== id) return ing;
                
                // Merge updates
                const newItem = { ...ing, ...updates };

                // If Price, InputAmount, or InputUnit changed, we must recalculate amount and note
                if ('price' in updates || 'inputAmount' in updates || 'inputUnit' in updates) {
                    let finalAmount = parseFloat(newItem.inputAmount);
                    let finalUnit = newItem.unit; // Default keep current internal unit

                    // Recalculate normalized amount if unit/amount changed
                    // é€™è£¡çš„é‚è¼¯ï¼šä¿æŒ inputUnit ä¸è®Šï¼Œä½†é‡æ–°è¨ˆç®— internal amount (g/ml)
                    if (['kg', 'å…¬æ–¤'].includes(newItem.inputUnit)) { finalAmount *= 1000; finalUnit = 'g'; }
                    else if (['å°æ–¤'].includes(newItem.inputUnit)) { finalAmount *= 600; finalUnit = 'g'; }
                    else if (['l', 'å…¬å‡', 'L'].includes(newItem.inputUnit)) { finalAmount *= 1000; finalUnit = 'ml'; }
                    else { finalUnit = newItem.inputUnit; } // e.g. å€‹, ç½

                    newItem.amount = finalAmount;
                    newItem.unit = finalUnit;
                    
                    // Auto-update Note text to reflect new specs
                    newItem.note = `${newItem.inputAmount}${newItem.inputUnit} $${newItem.price}`;
                }

                return newItem;
            }));
        };

        const handleSave = () => {
          if (!form.name || !form.price || !form.inputAmount) return alert('è«‹å¡«å¯«å®Œæ•´');
          const isDuplicate = ingredients.some(i => i.name === form.name && i.id !== isEditing);
          if (isDuplicate) return alert('å·²æœ‰ç›¸åŒåç¨±çš„åŸæ–™ï¼Œè«‹å‹¿é‡è¤‡å»ºç«‹ï¼');

          let finalAmount = parseFloat(form.inputAmount);
          if (form.inputUnit === 'kg') finalAmount *= 1000;
          if (form.inputUnit === 'å°æ–¤') finalAmount *= 600;
          if (form.inputUnit === 'L') finalAmount *= 1000;

          const item = {
            id: isEditing || Date.now(),
            name: form.name,
            category: form.category,
            price: parseFloat(form.price),
            amount: finalAmount,
            unit: form.calcUnit,
            
            // Save input specs for intuitive editing later
            inputAmount: parseFloat(form.inputAmount),
            inputUnit: form.inputUnit,

            vendorId: form.vendorId,
            yieldRate: parseFloat(form.yieldRate) || 100,
            note: `${form.inputAmount}${form.inputUnit} $${form.price}`
          };

          if (isEditing) setIngredients(prev => prev.map(i => i.id === isEditing ? item : i));
          else setIngredients(prev => [...prev, item]);
          
          setIsEditing(null);
          setForm({ name: '', category: 'è‚‰æµ·é®®é¡', price: '', inputAmount: '', inputUnit: 'kg', calcUnit: 'g', vendorId: '', yieldRate: 100 });
        };
        
        // ... (Import/Export logic omitted for brevity, same as v3.8) ...

        const filtered = filterCat === 'ALL' ? ingredients : ingredients.filter(i => i.category === filterCat);

        return (
          <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-slate-800">åŸæ–™ç®¡ç†</h2>
              <div className="text-xs text-slate-500 bg-yellow-100 px-2 py-1 rounded border border-yellow-200">
                ğŸ’¡ æç¤ºï¼šä¿®æ”¹ã€Œé€²è²¨è¦æ ¼ã€æˆ–ã€Œåƒ¹æ ¼ã€æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•é€£å‹•æ›´æ–°å–®ä½æˆæœ¬èˆ‡å‚™è¨»ã€‚
              </div>
            </div>
            
            {/* æ–°å¢åŸæ–™è¡¨å–® (Collapsible ideally, but kept expanded for now) */}
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
              <h3 className="font-bold text-brand mb-4 flex items-center gap-2">{isEditing ? <Edit3 size={18}/> : <Plus size={18}/>} {isEditing ? 'ç·¨è¼¯' : 'æ–°å¢'}åŸæ–™</h3>
              <div className={`grid grid-cols-1 ${md('md:grid-cols-6')} gap-4 items-end`}>
                 {/* ... Form Inputs (same as V3.8) ... */}
                 <div className={`${md('md:col-span-1')}`}>
                  <label className="text-xs font-bold text-slate-500">åˆ†é¡</label>
                  <select className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                    {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div className={`${md('md:col-span-1')}`}>
                  <label className="text-xs font-bold text-slate-500">å“å</label>
                  <input className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" placeholder="å¦‚: æ´‹è”¥" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                </div>
                <div className={`${md('md:col-span-1')}`}>
                  <label className="text-xs font-bold text-slate-500">å» å•†</label>
                  <select className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" value={form.vendorId} onChange={e => setForm({...form, vendorId: e.target.value})}>
                    <option value="">-- æœªæŒ‡å®š --</option>
                    {vendors.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                  </select>
                </div>
                <div className={`${md('md:col-span-1')}`}>
                  <label className="text-xs font-bold text-slate-500">é€²è²¨åƒ¹æ ¼ ($)</label>
                  <input type="number" className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" placeholder="900" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
                </div>
                <div className={`${md('md:col-span-2')} bg-slate-50 p-2 rounded border border-slate-200 grid grid-cols-2 gap-2`}>
                    <div>
                      <label className="text-xs font-bold text-slate-500">é€²è²¨å–®ä½/é‡</label>
                      <div className="flex">
                        <input type="number" className="w-2/3 p-2 border rounded-l focus:ring-2 ring-brand outline-none z-10" placeholder="3" value={form.inputAmount} onChange={e => setForm({...form, inputAmount: e.target.value})} />
                        <select className="w-1/3 p-2 border rounded-r bg-white border-l-0 focus:ring-2 ring-brand outline-none" value={form.inputUnit} onChange={e => setForm({...form, inputUnit: e.target.value})}>
                          <option value="kg">kg</option>
                          <option value="å°æ–¤">å°æ–¤</option>
                          <option value="g">g</option>
                          <option value="L">L</option>
                          <option value="å€‹">å€‹</option>
                          <option value="ç½">ç½</option>
                        </select>
                      </div>
                    </div>
                    <div>
                      <label className="text-xs font-bold text-slate-500">æ”¶ç‡ %</label>
                      <input type="number" className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" placeholder="100" value={form.yieldRate} onChange={e => setForm({...form, yieldRate: e.target.value})} />
                    </div>
                </div>
                <div className={`${md('md:col-span-6')} flex gap-2`}>
                  <button onClick={handleSave} className="flex-1 bg-brand text-white p-2 rounded font-bold hover:opacity-90">{isEditing ? 'æ›´æ–°' : 'æ–°å¢'}</button>
                  {isEditing && <button onClick={() => setIsEditing(null)} className="px-3 bg-gray-400 text-white rounded">X</button>}
                </div>
              </div>
            </div>

            <div className="flex gap-2 mb-4 overflow-x-auto">
              <button onClick={() => setFilterCat('ALL')} className={`px-3 py-1 rounded-full text-xs ${filterCat==='ALL'?'bg-brand text-white':'bg-white border'}`}>å…¨éƒ¨</button>
              {CATEGORIES.map(c => <button key={c} onClick={() => setFilterCat(c)} className={`px-3 py-1 rounded-full text-xs ${filterCat===c?'bg-brand text-white':'bg-white border'}`}>{c}</button>)}
            </div>

            <div className="bg-white rounded-xl shadow overflow-hidden">
              <table className="w-full text-left">
                <thead className="bg-slate-50 text-slate-600 border-b text-sm">
                  <tr><th className="p-3">åˆ†é¡ / å“å / å» å•†</th><th className="p-3">é€²è²¨è¦æ ¼ (å¯ç·¨è¼¯)</th><th className="p-3">ç¸½åƒ¹</th><th className="p-3">å–®ä½æˆæœ¬ (å«è€—æ)</th><th className="p-3 text-right">æ“ä½œ</th></tr>
                </thead>
                <tbody>
                  {filtered.map(ing => {
                    const vendor = vendors.find(v => v.id == ing.vendorId);
                    const realUnitCost = getUnitCost(ing);
                    return (
                      <tr key={ing.id} className={`border-b last:border-0 hover:bg-slate-50 ${ing.sourceRecipeId ? 'bg-purple-50' : ''}`}>
                        <td className="p-3 align-top">
                          <div className="flex flex-col gap-1">
                            {/* åˆ†é¡ - å¯ç·¨è¼¯ */}
                            <EditableCell 
                                type="select" 
                                value={ing.category} 
                                options={CATEGORIES.map(c => ({value: c, label: c}))}
                                onSave={(val) => updateIngredient(ing.id, {category: val})}
                                className="text-xs bg-slate-100 px-1 rounded w-fit mb-1"
                            />
                            {/* å“å - å¯ç·¨è¼¯ */}
                            <div className="flex items-center gap-2">
                                <EditableCell 
                                    value={ing.name} 
                                    onSave={(val) => updateIngredient(ing.id, {name: val})}
                                    className="font-bold text-slate-800"
                                />
                                {ing.sourceRecipeId && <span className="text-xs text-purple-600 border border-purple-200 bg-white px-1 rounded flex items-center gap-1"><Link2 size={10}/> å‹•æ…‹</span>}
                            </div>
                            {/* å» å•† - å¯ç·¨è¼¯ */}
                            <div className="text-xs text-slate-400 flex items-center gap-1 mt-1">
                                <Users size={10}/>
                                <EditableCell 
                                    type="select"
                                    value={ing.vendorId}
                                    options={[{value: '', label: '-- ç„¡ --'}, ...vendors.map(v => ({value: v.id, label: v.name}))]}
                                    onSave={(val) => updateIngredient(ing.id, {vendorId: val})}
                                />
                            </div>
                          </div>
                        </td>
                        <td className="p-3 text-sm text-slate-600 align-top">
                          {/* è¦æ ¼ - å¯ç·¨è¼¯ (æ ¸å¿ƒé€£å‹•) */}
                          <div className="flex items-center gap-1 font-medium bg-blue-50 px-2 py-1 rounded border border-blue-100 w-fit">
                              <EditableCell 
                                  type="number"
                                  value={ing.inputAmount || 1} 
                                  onSave={(val) => updateIngredient(ing.id, {inputAmount: val})}
                                  className="w-16"
                              />
                              <EditableCell 
                                  type="select"
                                  value={ing.inputUnit || ing.unit} 
                                  options={['kg','å°æ–¤','g','L','å€‹','é¡†','ç½','åŒ…'].map(u=>({value:u, label:u}))}
                                  onSave={(val) => updateIngredient(ing.id, {inputUnit: val})}
                                  className="w-12 text-slate-500"
                              />
                          </div>
                          {ing.yieldRate < 100 && <div className="text-xs text-slate-400 mt-1">æ”¶ç‡: {ing.yieldRate}%</div>}
                          <div className="text-[10px] text-slate-300 mt-1">{ing.note}</div>
                        </td>
                        <td className="p-3 align-top">
                            {/* åƒ¹æ ¼ - å¯ç·¨è¼¯ (æ ¸å¿ƒé€£å‹•) */}
                            <div className="font-bold text-slate-700 flex items-center gap-1">
                                $ <EditableCell 
                                    type="number"
                                    value={ing.price}
                                    onSave={(val) => updateIngredient(ing.id, {price: val})}
                                    className="text-lg"
                                />
                            </div>
                        </td>
                        <td className="p-3 align-top">
                          <span className={`px-2 py-1 rounded font-mono font-bold text-sm ${isWeightUnit(ing.unit) ? 'unit-weight' : 'unit-qty'}`}>
                            ${realUnitCost.toFixed(4)} / {ing.unit}
                          </span>
                        </td>
                        <td className="p-3 text-right space-x-1 align-top">
                          <button onClick={() => { setIsEditing(ing.id); setForm({ name: ing.name, category: ing.category, price: ing.price, inputAmount: ing.inputAmount||ing.amount, inputUnit: ing.inputUnit||ing.unit, calcUnit: ing.unit, vendorId: ing.vendorId, yieldRate: ing.yieldRate }); }} className="p-1 text-slate-400 hover:text-brand" title="å®Œæ•´ç·¨è¼¯"><Edit3 size={16}/></button>
                          <button onClick={() => confirm('åˆªé™¤ï¼Ÿ') && setIngredients(ingredients.filter(i=>i.id!==ing.id))} className="p-1 text-slate-400 hover:text-red-600" title="åˆªé™¤"><Trash2 size={16}/></button>
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      // --- Projection View (New Feature) ---
      const ProjectionView = () => {
        const updateSales = (id, val) => {
            setSalesData(prev => ({ ...prev, [id]: parseFloat(val) || 0 }));
        };

        const projection = useMemo(() => {
            let totalRevenue = 0;
            let totalCost = 0;
            
            // Merge Recipes and Sets
            const allItems = [
                ...recipes.map(r => ({ ...r, type: 'å–®å“', cost: calcRecipeCost(r.items) })),
                ...sets.map(s => {
                    const cost = s.items.reduce((sum, i) => { 
                        const r = recipes.find(x => x.id === i.recipeId); 
                        return sum + (r ? calcRecipeCost(r.items) * i.count : 0); 
                    }, 0);
                    return { ...s, type: 'å¥—é¤', cost };
                })
            ];

            const rows = allItems.map(item => {
                const qty = salesData[item.id] || 0;
                const subRevenue = qty * item.sellingPrice;
                const subCost = qty * item.cost;
                totalRevenue += subRevenue;
                totalCost += subCost;
                return { ...item, qty, subRevenue, subCost };
            });

            const totalProfit = totalRevenue - totalCost;
            const totalMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            const costPct = totalRevenue > 0 ? (totalCost / totalRevenue) * 100 : 0;

            return { rows, totalRevenue, totalCost, totalProfit, totalMargin, costPct };
        }, [recipes, sets, ingredients, salesData]);

        return (
            <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
                <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2"><BarChart3/> ç‡Ÿæ”¶é ä¼°æ¨¡æ“¬å™¨</h2>
                
                {/* Dashboard Summary */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-200">
                        <div className="text-sm text-slate-500 mb-1">é ä¼°æœˆç‡Ÿæ¥­é¡</div>
                        <div className="text-3xl font-bold text-blue-600">${projection.totalRevenue.toLocaleString()}</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-emerald-200">
                        <div className="text-sm text-slate-500 mb-1">é ä¼°ç¸½æ¯›åˆ© (ç‡)</div>
                        <div className="flex items-end gap-2">
                            <div className="text-3xl font-bold text-emerald-600">${projection.totalProfit.toLocaleString()}</div>
                            <div className="text-lg font-bold text-emerald-400 mb-1">({projection.totalMargin.toFixed(1)}%)</div>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-red-200">
                        <div className="text-sm text-slate-500 mb-1">é ä¼°é£Ÿææ¡è³¼æˆæœ¬</div>
                        <div className="flex items-end gap-2">
                            <div className="text-3xl font-bold text-red-600">${projection.totalCost.toLocaleString()}</div>
                            <div className="text-lg font-bold text-red-400 mb-1">({projection.costPct.toFixed(1)}%)</div>
                        </div>
                    </div>
                </div>

                {/* Input Table */}
                <div className="bg-white rounded-xl shadow border overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <h3 className="font-bold text-slate-700">éŠ·å”®é‡è¼¸å…¥</h3>
                        <button onClick={() => setSalesData({})} className="text-sm text-red-500 hover:underline">æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 text-slate-600 border-b text-sm">
                                <tr>
                                    <th className="p-3">é¡åˆ¥</th>
                                    <th className="p-3">å“é …åç¨±</th>
                                    <th className="p-3 text-right">å–®åƒ¹</th>
                                    <th className="p-3 text-right">å–®ä½æˆæœ¬</th>
                                    <th className="p-3 text-right">å–®å“æ¯›åˆ©</th>
                                    <th className="p-3 text-center w-32 bg-orange-50 border-x border-orange-100">é ä¼°æœˆéŠ·é‡</th>
                                    <th className="p-3 text-right">ç‡Ÿæ”¶å°è¨ˆ</th>
                                    <th className="p-3 text-right">æˆæœ¬å°è¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {projection.rows.map(row => {
                                    const margin = row.sellingPrice > 0 ? ((row.sellingPrice - row.cost)/row.sellingPrice)*100 : 0;
                                    return (
                                        <tr key={row.id} className="hover:bg-slate-50">
                                            <td className="p-3"><span className={`text-xs px-2 py-1 rounded ${row.type==='å¥—é¤'?'bg-purple-100 text-purple-700':'bg-blue-100 text-blue-700'}`}>{row.type}</span></td>
                                            <td className="p-3 font-medium text-slate-700">{row.name}</td>
                                            <td className="p-3 text-right text-slate-500">${row.sellingPrice}</td>
                                            <td className="p-3 text-right text-slate-400">${row.cost.toFixed(1)}</td>
                                            <td className="p-3 text-right"><MarginBadge val={margin} /></td>
                                            <td className="p-3 text-center bg-orange-50/30 border-x border-orange-100">
                                                <input 
                                                    type="number" 
                                                    className="w-24 p-1 border border-brand/50 rounded text-center font-bold focus:ring-2 ring-brand outline-none"
                                                    value={salesData[row.id] || ''}
                                                    onChange={e => updateSales(row.id, e.target.value)}
                                                    placeholder="0"
                                                />
                                            </td>
                                            <td className="p-3 text-right font-bold text-blue-600">${row.subRevenue.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono text-red-500">${row.subCost.toLocaleString()}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
      };

      // ... (VendorsView, RecipesView, SetsView, DashboardView logic same as v3.8, just passed through) ...
      // ä¸ºäº†ç¯€çœç¯‡å¹…ï¼Œé€™è£¡é‡è¤‡åˆ©ç”¨ V3.8 çš„çµ„ä»¶é‚è¼¯ï¼Œä½†åœ¨å¯¦éš›æ•´åˆæ™‚æœƒå…¨éƒ¨åŒ…å«åœ¨å…§ã€‚
      // ä¸‹é¢æˆ‘å°‡å®Œæ•´åˆ—å‡ºé‚£äº›æœªè®Šå‹•çš„ View ä»¥ç¢ºä¿é€™æ˜¯ä¸€å€‹å®Œæ•´çš„æª”æ¡ˆã€‚

      const VendorsView = () => {  
        const [isEditing, setIsEditing] = useState(null);
        const [form, setForm] = useState({ name: '', contact: '', phone: '', note: '' });
        const save = () => {
          if(!form.name) return alert('è«‹è¼¸å…¥å» å•†åç¨±');
          const item = { id: isEditing || Date.now(), ...form };
          if(isEditing) setVendors(prev => prev.map(v => v.id === isEditing ? item : v));
          else setVendors(prev => [...prev, item]);
          setIsEditing(null); setForm({ name: '', contact: '', phone: '', note: '' });
        };
        return (
          <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
            <h2 className="text-2xl font-bold text-slate-800 mb-6">å» å•†ç®¡ç†</h2>
            <div className="bg-white p-6 rounded-xl shadow-sm border mb-8">
              <h3 className="font-bold text-slate-700 mb-4">{isEditing ? 'ç·¨è¼¯å» å•†' : 'æ–°å¢å» å•†'}</h3>
              <div className={`grid grid-cols-1 ${md('md:grid-cols-4')} gap-4`}>
                <div><label className="text-xs text-slate-500">å» å•†åç¨±</label><input className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="ä¾‹å¦‚: å¥½å¸‚å¤š" /></div>
                <div><label className="text-xs text-slate-500">è¯çµ¡äºº</label><input className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" value={form.contact} onChange={e => setForm({...form, contact: e.target.value})} /></div>
                <div><label className="text-xs text-slate-500">é›»è©±</label><input className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} /></div>
                <div><label className="text-xs text-slate-500">å‚™è¨»</label><input className="w-full p-2 border rounded focus:ring-2 ring-brand outline-none" value={form.note} onChange={e => setForm({...form, note: e.target.value})} /></div>
                <div className={`${md('md:col-span-4')} flex gap-2`}>
                  <button onClick={save} className="bg-brand text-white px-6 py-2 rounded font-bold">{isEditing ? 'æ›´æ–°' : 'æ–°å¢'}</button>
                  {isEditing && <button onClick={() => {setIsEditing(null); setForm({ name: '', contact: '', phone: '', note: '' });}} className="bg-gray-400 text-white px-4 rounded">å–æ¶ˆ</button>}
                </div>
              </div>
            </div>
            <div className="bg-white rounded-xl shadow overflow-hidden">
              <table className="w-full text-left">
                <thead className="bg-slate-50 border-b"><tr><th className="p-4">åç¨±</th><th className="p-4">è¯çµ¡è³‡è¨Š</th><th className="p-4">å‚™è¨»</th><th className="p-4 text-right">æ“ä½œ</th></tr></thead>
                <tbody>{vendors.map(v => (<tr key={v.id} className="border-b hover:bg-slate-50"><td className="p-4 font-bold">{v.name}</td><td className="p-4 text-sm"><div>{v.contact}</div><div className="text-slate-400">{v.phone}</div></td><td className="p-4 text-sm text-slate-500">{v.note}</td><td className="p-4 text-right"><button onClick={() => {setIsEditing(v.id); setForm(v);}} className="text-slate-400 hover:text-brand mr-2"><Edit3 size={16}/></button><button onClick={() => confirm('ç¢ºèªåˆªé™¤?') && setVendors(p => p.filter(x=>x.id!==v.id))} className="text-slate-400 hover:text-red-600"><Trash2 size={16}/></button></td></tr>))}</tbody>
              </table>
            </div>
          </div>
        );
      };

      // ... RecipesView, SetsView, DashboardView are identical to V3.8, included below ...
      const RecipesView = () => {
        const [viewMode, setViewMode] = useState('list');
        const [layout, setLayout] = useState('grid');
        const [searchTerm, setSearchTerm] = useState('');
        const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'asc' });
        const [form, setForm] = useState({ name: '', sellingPrice: '', deliveryRate: 32, deliveryPrice: '', items: [] });
        const [editingId, setEditingId] = useState(null);
        const [isReadOnly, setIsReadOnly] = useState(false);

        // ... (çœç•¥éƒ¨åˆ†é‡è¤‡é‚è¼¯ï¼Œå¦‚ Import/Export/Calculationsï¼Œçš†å¼•ç”¨å¤–å±¤å®šç¾©) ...
        // ç›´æ¥å¾©ç”¨ enrichedRecipes, processedRecipes é‚è¼¯

        const enrichedRecipes = useMemo(() => {
          return recipes.map(r => {
            const cost = calcRecipeCost(r.items);
            const weight = calcRecipePureWeight(r.items);
            const displayW = calcRecipeDisplay(r.items);
            const margin = r.sellingPrice > 0 ? ((r.sellingPrice - cost) / r.sellingPrice) * 100 : 0;
            const delPrice = parseFloat(r.deliveryPrice) || parseFloat(r.sellingPrice) || 0;
            const delCommission = (delPrice * (parseFloat(r.deliveryRate) || 0)) / 100;
            const delProfit = delPrice - delCommission - cost;
            return { ...r, cost, weight, displayW, margin, delProfit };
          });
        }, [recipes, ingredients]);

        const processedRecipes = useMemo(() => {
          let result = enrichedRecipes.filter(r => r.name.toLowerCase().includes(searchTerm.toLowerCase()));
          result.sort((a, b) => {
            if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
            if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
          });
          return result;
        }, [enrichedRecipes, searchTerm, sortConfig]);

        const handleSort = (key) => {
          setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }));
        };

        const SearchableSelect = ({ value, onChange, disabled }) => {
          const [isOpen, setIsOpen] = useState(false); const [search, setSearch] = useState('');
          useEffect(() => { const s = ingredients.find(i => i.id === value); setSearch(s ? s.name : ''); }, [value, ingredients]);
          const filtered = ingredients.filter(i => i.name.toLowerCase().includes(search.toLowerCase()) || (i.category||'').includes(search));
          return (
            <div className="relative flex-1 min-w-[150px]">
              <input disabled={disabled} className={`w-full p-2 border rounded focus:ring-2 ring-brand outline-none ${disabled ? 'input-disabled' : ''}`} value={search} onChange={e=>{setSearch(e.target.value);setIsOpen(true)}} onFocus={()=>!disabled && setIsOpen(true)} onBlur={()=>setTimeout(()=>setIsOpen(false),200)} placeholder="æœå°‹..."/>
              {isOpen && !disabled && <div className="absolute z-50 w-full mt-1 bg-white border rounded shadow-xl max-h-60 overflow-y-auto">{filtered.map(i => (
                <div key={i.id} className="p-2 hover:bg-orange-50 cursor-pointer text-sm flex justify-between" onMouseDown={()=>{onChange({target:{value:i.id}}); setSearch(i.name); setIsOpen(false);}}>
                  <span>{i.name}</span><span className="text-xs text-slate-400">${getUnitCost(i).toFixed(4)}/{i.unit}</span>
                </div>
              ))}</div>}
            </div>
          );
        };

        const startEdit = (r) => {
          setEditingId(r ? r.id : 'new');
          setForm(r ? { ...r, items: [...r.items] } : { name: '', sellingPrice: '', deliveryRate: 32, deliveryPrice: '', items: [] });
          setIsReadOnly(!!r); 
          setViewMode('edit');
        };

        const save = () => {
          if (!form.name) return alert('è«‹è¼¸å…¥åç¨±');
          const item = { ...form, id: editingId === 'new' ? Date.now() : editingId };
          setRecipes(prev => editingId === 'new' ? [...prev, item] : prev.map(r => r.id === editingId ? item : r));
          setViewMode('list');
        };

        const saveAsIngredient = () => {
            if (!form.name || form.items.length === 0) return alert('è«‹å…ˆå»ºç«‹é…æ–¹');
            const cost = calcRecipeCost(form.items);
            const rawWeight = calcRecipePureWeight(form.items); 
            const finalWeightStr = prompt(`ã€å»ºç«‹å‹•æ…‹çµ„åˆåŸæ–™ã€‘\næ­¤é…æ–¹æœƒèˆ‡åŸæ–™åº«å»ºç«‹é€£çµï¼Œæˆæœ¬å°‡éš¨æ™‚è‡ªå‹•æ›´æ–°ã€‚\n\nåŸå§‹é‡é‡: ${rawWeight.toFixed(1)}g\nè«‹è¼¸å…¥ã€Œæˆå“æœ€çµ‚é‡é‡ (g)ã€ä»¥è¨ˆç®—æ¿ƒç¸®/è€—æï¼š`, rawWeight);
            if (finalWeightStr === null) return;
            const finalWeight = parseFloat(finalWeightStr) || rawWeight;
            
            let recipeId = editingId;
            if (recipeId === 'new') {
               recipeId = Date.now();
               const newRecipe = { ...form, id: recipeId };
               setRecipes(prev => [...prev, newRecipe]);
               setEditingId(recipeId);
            }
  
            const newIng = {
              id: Date.now() + 1, name: `[çµ„åˆ] ${form.name}`, category: 'çµ„åˆææ–™', price: 0, amount: finalWeight, unit: 'g', sourceRecipeId: recipeId,
              inputAmount: finalWeight, inputUnit: 'g',
              note: `é€£çµé…æ–¹: ${form.name} (ç”¢å‡º:${finalWeight}g)`
            };
            setIngredients(prev => [...prev, newIng]);
            alert(`å·²å»ºç«‹å‹•æ…‹åŸæ–™ï¼`);
        };

        const cost = calcRecipeCost(form.items);
        const displayWeight = calcRecipeDisplay(form.items);
        const profit = (parseFloat(form.sellingPrice) || 0) - cost;
        const margin = parseFloat(form.sellingPrice) > 0 ? (profit / parseFloat(form.sellingPrice)) * 100 : 0;

        if (viewMode === 'edit') return (
          <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow p-6">
              <div className="flex justify-between mb-6 border-b pb-4">
                <h2 className="text-xl font-bold flex items-center gap-2">
                  {isReadOnly ? <Lock className="text-slate-400" size={20}/> : <Unlock className="text-brand" size={20}/>} 
                  {isReadOnly ? 'å–®å“è©³æƒ… (å”¯è®€)' : 'å–®å“ç·¨è¼¯'}
                </h2>
                <div className="space-x-2">
                   <button onClick={saveAsIngredient} className="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200 font-bold border border-purple-200 flex items-center gap-1 inline-flex"><Link2 size={12}/> è½‰å­˜ç‚ºå‹•æ…‹åŸæ–™</button>
                   <button onClick={() => setViewMode('list')} className="text-slate-500 border px-3 py-1 rounded hover:bg-slate-100">è¿”å›</button>
                </div>
              </div>
              
              <div className={`grid grid-cols-1 ${md('md:grid-cols-2')} gap-6 mb-6`}>
                <div className="space-y-4">
                  <h3 className="font-bold text-slate-700">åŸºæœ¬è³‡æ–™</h3>
                  <div><label className="text-xs font-bold text-slate-500">å“å</label><input disabled={isReadOnly} className={`w-full p-2 border rounded ${isReadOnly?'input-disabled':''}`} value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div>
                  <div><label className="text-xs font-bold text-slate-500">åº—å…§å”®åƒ¹</label><input disabled={isReadOnly} type="number" className={`w-full p-2 border rounded ${isReadOnly?'input-disabled':''}`} value={form.sellingPrice} onChange={e => setForm({...form, sellingPrice: e.target.value})} /></div>
                </div>
                <div className="space-y-4 bg-orange-50 p-4 rounded border border-orange-100">
                   <h3 className="font-bold text-orange-800">å¤–é€è©¦ç®—</h3>
                   <div className="flex gap-2">
                     <input disabled={isReadOnly} type="number" className={`w-1/2 p-2 border rounded ${isReadOnly?'input-disabled':''}`} placeholder="æŠ½æˆ%" value={form.deliveryRate} onChange={e => setForm({...form, deliveryRate: e.target.value})} />
                     <input disabled={isReadOnly} type="number" className={`w-1/2 p-2 border rounded ${isReadOnly?'input-disabled':''}`} placeholder="å¤–é€åƒ¹" value={form.deliveryPrice} onChange={e => setForm({...form, deliveryPrice: e.target.value})} />
                   </div>
                </div>
              </div>
              
              <div className="mb-4 flex justify-between items-end border-b pb-2">
                <h3 className="font-bold text-slate-700">é£Ÿæé…æ–¹</h3>
                {!isReadOnly && <button onClick={() => setForm({...form, items: [...form.items, { ingredientId: '', usage: 0 }]})} className="text-sm bg-brand text-white px-3 py-1 rounded"><Plus size={14} className="inline"/> åŠ å…¥</button>}
              </div>
              <div className="space-y-2 mb-8">
                {form.items.map((item, idx) => {
                  const ing = ingredients.find(i => i.id === Number(item.ingredientId));
                  return (
                    <div key={idx} className="flex gap-2 items-center p-2 rounded border bg-white">
                      <div className="flex-1"><SearchableSelect disabled={isReadOnly} value={item.ingredientId} onChange={e => { const newItems = [...form.items]; newItems[idx].ingredientId = Number(e.target.value); setForm({...form, items: newItems}); }} /></div>
                      <input disabled={isReadOnly} type="number" className={`w-20 p-2 border rounded ${isReadOnly?'input-disabled':''}`} value={item.usage} onChange={e => { const newItems = [...form.items]; newItems[idx].usage = parseFloat(e.target.value); setForm({...form, items: newItems}); }} placeholder="é‡" />
                      <span className="w-8 text-sm text-slate-500">{ing ? ing.unit : ''}</span>
                      <div className="w-20 text-right font-mono">${ing ? (getUnitCost(ing)*item.usage).toFixed(1) : 0}</div>
                      {!isReadOnly && <button onClick={() => setForm({...form, items: form.items.filter((_,i) => i !== idx)})} className="text-red-400"><Trash2 size={16}/></button>}
                    </div>
                  )
                })}
              </div>

              <div className="bg-slate-800 text-white p-4 rounded-xl flex justify-between items-center shadow-lg text-sm">
                <div className="flex gap-6">
                  <div><div className="text-slate-400">ç¸½æˆæœ¬</div><div className="text-xl text-red-300 font-bold">${cost.toFixed(1)}</div></div>
                  <div><div className="text-slate-400">ç¸½è¦æ ¼</div><div className="text-lg text-blue-300 font-bold">{displayWeight}</div></div>
                  <div><div className="text-slate-400">æ¯›åˆ©</div><div className="text-xl text-emerald-400 font-bold">${profit.toFixed(1)}</div></div>
                </div>
                {/* ç‹€æ…‹åˆ‡æ›æŒ‰éˆ• */}
                {isReadOnly ? (
                  <button onClick={() => setIsReadOnly(false)} className="bg-slate-600 hover:bg-slate-500 px-6 py-2 rounded font-bold flex items-center gap-2"><Edit3 size={16}/> è§£é–ç·¨è¼¯</button>
                ) : (
                  <button onClick={save} className="bg-brand px-6 py-2 rounded font-bold hover:opacity-90">å„²å­˜</button>
                )}
              </div>
            </div>
          </div>
        );

        return (
          <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <h2 className="text-2xl font-bold text-slate-800">å–®å“/é…æ–¹åˆ—è¡¨ ({recipes.length})</h2>
              
              <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                <div className="relative">
                  <input 
                    className="pl-8 pr-4 py-2 border rounded-lg focus:ring-2 ring-brand outline-none w-full" 
                    placeholder="æœå°‹ç”¢å“..." 
                    value={searchTerm} 
                    onChange={e => setSearchTerm(e.target.value)} 
                  />
                  <span className="absolute left-2.5 top-2.5 text-slate-400"><Search size={16}/></span>
                </div>
                
                <div className="flex bg-white rounded-lg border overflow-hidden shrink-0">
                  <button onClick={() => setLayout('grid')} className={`p-2 ${layout==='grid'?'bg-brand-light text-brand':'text-slate-400 hover:bg-slate-50'}`} title="å¡ç‰‡æª¢è¦–"><LayoutGrid size={18}/></button>
                  <button onClick={() => setLayout('list')} className={`p-2 ${layout==='list'?'bg-brand-light text-brand':'text-slate-400 hover:bg-slate-50'}`} title="æ¸…å–®æª¢è¦–"><List size={18}/></button>
                  <button onClick={() => setLayout('detail')} className={`p-2 ${layout==='detail'?'bg-brand-light text-brand':'text-slate-400 hover:bg-slate-50'}`} title="è©³ç´°è³‡æ–™"><Table size={18}/></button>
                </div>
                <button onClick={() => startEdit(null)} className="bg-brand text-white px-4 py-2 rounded-lg flex items-center gap-2 shrink-0 hover:opacity-90"><Plus size={18}/> æ–°å¢</button>
              </div>
            </div>

            {/* Grid View */}
            {layout === 'grid' && (
              <div className={`grid grid-cols-1 ${md('md:grid-cols-2 lg:grid-cols-3')} gap-6`}>
                {processedRecipes.map(r => (
                  <div key={r.id} className="bg-white p-5 rounded-xl shadow-sm border hover:shadow-md transition-shadow cursor-pointer" onClick={() => startEdit(r)}>
                    <div className="flex justify-between mb-3">
                      <h3 className="font-bold text-lg">{r.name}</h3>
                      <button onClick={(e) => { e.stopPropagation(); startEdit(r); }} className="text-slate-400 hover:text-brand"><Edit3 size={16}/></button>
                    </div>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between"><span>å”®åƒ¹</span><span className="font-bold">${r.sellingPrice}</span></div>
                      <div className="flex justify-between text-slate-500"><span>æˆæœ¬</span><span className="text-red-500">${r.cost.toFixed(1)}</span></div>
                      <div className="border-t pt-2 flex justify-between font-bold"><span>æ¯›åˆ©ç‡</span><MarginBadge val={r.margin} /></div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            {/* List/Detail Views omitted for brevity, logic identical to v3.8 */}
            {layout === 'list' && (
              <div className="bg-white rounded-xl shadow border overflow-hidden">
                {processedRecipes.map(r => (
                  <div key={r.id} className="flex justify-between items-center p-4 border-b last:border-0 hover:bg-slate-50 cursor-pointer" onClick={() => startEdit(r)}>
                    <div className="font-bold text-slate-700">{r.name}</div>
                    <div className="flex gap-6 text-sm">
                      <div className="text-center w-20"><div className="text-xs text-slate-400">å”®åƒ¹</div><div>${r.sellingPrice}</div></div>
                      <div className="text-center w-20"><div className="text-xs text-slate-400">æˆæœ¬</div><div className="text-red-500">${r.cost.toFixed(1)}</div></div>
                      <div className="text-center w-20"><div className="text-xs text-slate-400">æ¯›åˆ©</div><MarginBadge val={r.margin} /></div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            {layout === 'detail' && (
              <div className="bg-white rounded-xl shadow border overflow-x-auto">
                <table className="w-full text-left text-sm whitespace-nowrap">
                  <thead className="bg-slate-50 text-slate-600 font-bold border-b">
                    <tr>
                      <th className="p-4 sortable-header" onClick={() => handleSort('name')}>å“å <ArrowUpDown size={12} className="inline"/></th>
                      <th className="p-4 sortable-header text-right" onClick={() => handleSort('sellingPrice')}>å”®åƒ¹ <ArrowUpDown size={12} className="inline"/></th>
                      <th className="p-4 sortable-header text-right" onClick={() => handleSort('cost')}>æˆæœ¬ <ArrowUpDown size={12} className="inline"/></th>
                      <th className="p-4 sortable-header text-right" onClick={() => handleSort('margin')}>æ¯›åˆ©ç‡ <ArrowUpDown size={12} className="inline"/></th>
                      <th className="p-4 sortable-header text-right" onClick={() => handleSort('weight')}>æ·¨é‡ <ArrowUpDown size={12} className="inline"/></th>
                      <th className="p-4 sortable-header text-right" onClick={() => handleSort('delProfit')}>å¤–é€ç²åˆ© <ArrowUpDown size={12} className="inline"/></th>
                      <th className="p-4 text-center">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {processedRecipes.map(r => (
                      <tr key={r.id} className="border-b last:border-0 hover:bg-slate-50 cursor-pointer" onClick={() => startEdit(r)}>
                        <td className="p-4 font-bold text-slate-700">{r.name}</td>
                        <td className="p-4 text-right">${r.sellingPrice}</td>
                        <td className="p-4 text-right text-red-500">${r.cost.toFixed(1)}</td>
                        <td className="p-4 text-right"><MarginBadge val={r.margin} /></td>
                        <td className="p-4 text-right text-blue-500">{r.displayW}</td>
                        <td className="p-4 text-right text-orange-600">${r.delProfit.toFixed(1)}</td>
                        <td className="p-4 text-center">
                          <button onClick={(e) => { e.stopPropagation(); startEdit(r); }} className="text-slate-400 hover:text-brand p-1"><Edit3 size={16}/></button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        );
      };

      const SetsView = () => {
        const [isEditing, setIsEditing] = useState(false);
        const [form, setForm] = useState({ name: '', sellingPrice: '', items: [] });
        const [editId, setEditId] = useState(null);

        const updateItem = (rid, delta) => {
          setForm(prev => {
            const existing = prev.items.find(i => i.recipeId === rid);
            if (existing) {
              const newCount = existing.count + delta;
              return { ...prev, items: newCount <= 0 ? prev.items.filter(i => i.recipeId !== rid) : prev.items.map(i => i.recipeId === rid ? { ...i, count: newCount } : i) };
            } else if (delta > 0) return { ...prev, items: [...prev.items, { recipeId: rid, count: 1 }] };
            return prev;
          });
        };

        const totalCost = form.items.reduce((sum, item) => {
          const r = recipes.find(x => x.id === item.recipeId);
          return sum + (r ? calcRecipeCost(r.items) * item.count : 0);
        }, 0);
        const margin = parseFloat(form.sellingPrice) > 0 ? ((parseFloat(form.sellingPrice) - totalCost) / parseFloat(form.sellingPrice)) * 100 : 0;

        if (isEditing) return (
          <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow p-6">
              <h2 className="text-xl font-bold mb-6">å¥—é¤è¨­å®š</h2>
              <div className="flex gap-4 mb-6">
                <input className="flex-1 p-2 border rounded" placeholder="å¥—é¤åç¨±" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                <input type="number" className="w-32 p-2 border rounded" placeholder="å”®åƒ¹" value={form.sellingPrice} onChange={e => setForm({...form, sellingPrice: e.target.value})} />
              </div>
              <h3 className="font-bold text-slate-700 mb-2">é¸æ“‡å…§å®¹</h3>
              <div className={`grid grid-cols-2 ${md('md:grid-cols-3')} gap-2 mb-6 max-h-60 overflow-y-auto border p-2 rounded bg-slate-50 custom-scrollbar`}>
                {recipes.map(r => {
                  const inSet = form.items.find(i => i.recipeId === r.id);
                  return (
                    <div key={r.id} className={`flex justify-between items-center p-2 border rounded ${inSet ? 'bg-orange-50 border-brand' : ''}`}>
                      <span className="text-sm">{r.name}</span>
                      <div className="flex items-center gap-2">
                        {inSet && <button onClick={() => updateItem(r.id, -1)} className="w-6 h-6 bg-white border rounded flex items-center justify-center">-</button>}
                        <span className="font-bold w-4 text-center">{inSet ? inSet.count : 0}</span>
                        <button onClick={() => updateItem(r.id, 1)} className="w-6 h-6 bg-brand text-white rounded flex items-center justify-center">+</button>
                      </div>
                    </div>
                  )
                })}
              </div>
              <div className="bg-slate-800 text-white p-4 rounded-xl flex justify-between items-center">
                 <div>ç¸½æˆæœ¬ <span className="text-red-300 text-xl font-bold">${totalCost.toFixed(1)}</span> | æ¯›åˆ© <span className={margin<targetMargin?'text-red-500':'text-emerald-400'}>{margin.toFixed(1)}%</span></div>
                 <div className="space-x-2">
                   <button onClick={() => setIsEditing(false)} className="px-4 text-slate-400">å–æ¶ˆ</button>
                   <button onClick={() => {
                     const item = { ...form, id: editId === 'new' ? Date.now() : editId };
                     setSets(prev => editId === 'new' ? [...prev, item] : prev.map(s => s.id === editId ? item : s));
                     setIsEditing(false);
                   }} className="bg-brand px-6 py-2 rounded font-bold">å„²å­˜</button>
                 </div>
              </div>
            </div>
          </div>
        );

        return (
          <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
            <div className="flex justify-between mb-6">
              <h2 className="text-2xl font-bold text-slate-800">å¥—é¤åˆ—è¡¨</h2>
              <button onClick={() => { setEditId('new'); setForm({ name: '', sellingPrice: '', items: [] }); setIsEditing(true); }} className="bg-brand text-white px-4 py-2 rounded flex items-center gap-2"><Plus size={18}/> æ–°å¢</button>
            </div>
            <div className="grid grid-cols-1 gap-4">
              {sets.map(s => {
                const c = s.items.reduce((sum, i) => { const r = recipes.find(x => x.id === i.recipeId); return sum + (r ? calcRecipeCost(r.items) * i.count : 0); }, 0);
                const m = s.sellingPrice > 0 ? ((s.sellingPrice - c)/s.sellingPrice)*100 : 0;
                return (
                  <div key={s.id} className="bg-white p-4 rounded-xl shadow-sm border flex justify-between hover:shadow-md cursor-pointer" onClick={() => { setEditId(s.id); setForm(s); setIsEditing(true); }}>
                    <div><div className="font-bold text-lg">{s.name}</div><div className="text-xs text-slate-500">{s.items.map(i => { const r = recipes.find(x=>x.id===i.recipeId); return r ? `${r.name}x${i.count}` : ''; }).join(', ')}</div></div>
                    <div className="flex items-center gap-8">
                       <div className="text-right"><div className="text-xs text-slate-400">å”®åƒ¹</div><div className="font-bold">${s.sellingPrice}</div></div>
                       <div className="text-right"><div className="text-xs text-slate-400">æˆæœ¬</div><div className="text-red-500 font-bold">${c.toFixed(1)}</div></div>
                       <div className="text-right"><div className="text-xs text-slate-400">æ¯›åˆ©é¡</div><div className="font-bold text-emerald-600">${(s.sellingPrice - c).toFixed(1)}</div></div>
                       <div className="text-right"><div className="text-xs text-slate-400">æ¯›åˆ©ç‡</div><div className="font-bold"><MarginBadge val={m} /></div></div>
                       <div className="flex gap-1">
                         <button onClick={(e) => { e.stopPropagation(); setEditId(s.id); setForm(s); setIsEditing(true); }} className="p-2 bg-slate-100 rounded hover:bg-brand-light text-slate-600"><Edit3 size={16}/></button>
                         <button onClick={(e) => { e.stopPropagation(); confirm('åˆªé™¤?') && setSets(prev => prev.filter(x => x.id !== s.id)); }} className="p-2 bg-slate-100 rounded hover:bg-red-100 text-red-500"><Trash2 size={16}/></button>
                       </div>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        );
      };

      const DashboardView = () => {
        const lowMarginRecipes = recipes.filter(r => {
           const c = calcRecipeCost(r.items);
           return r.sellingPrice > 0 && ((r.sellingPrice - c)/r.sellingPrice)*100 < targetMargin;
        });

        return (
          <div className="p-6 h-full overflow-y-auto bg-gray-50 flex-1">
            <h2 className="text-2xl font-bold mb-6 text-slate-800">ç¸½è¦½åˆ†æ</h2>
            <div className={`grid grid-cols-1 ${md('md:grid-cols-4')} gap-6 mb-8`}>
               <div className="bg-white p-4 rounded-xl shadow-sm border">
                 <div className="text-sm text-slate-500">ç›®æ¨™æ¯›åˆ©ç‡</div>
                 <div className="flex items-center gap-2 mt-1">
                   <input type="number" className="text-2xl font-bold w-20 border-b-2 border-brand outline-none text-center" value={targetMargin} onChange={e => setTargetMargin(Number(e.target.value))} />
                   <span className="text-xl font-bold text-slate-700">%</span>
                 </div>
               </div>
               <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-sm text-slate-500">å–®å“ç¸½æ•¸</div><div className="text-2xl font-bold mt-1">{recipes.length}</div></div>
               <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-sm text-slate-500">å¥—é¤ç¸½æ•¸</div><div className="text-2xl font-bold mt-1">{sets.length}</div></div>
               <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-sm text-slate-500">ä½æ¯›åˆ©è­¦å‘Š</div><div className="text-2xl font-bold text-red-600 mt-1">{lowMarginRecipes.length}</div></div>
            </div>
            <div className="bg-white p-6 rounded-xl shadow-sm border">
               <h3 className="font-bold text-slate-700 mb-4 border-b pb-2">âš ï¸ éœ€æ³¨æ„çš„ä½æ¯›åˆ©å–®å“</h3>
               <div className="space-y-2">
                 {lowMarginRecipes.map(r => {
                   const c = calcRecipeCost(r.items);
                   const m = ((r.sellingPrice - c)/r.sellingPrice)*100;
                   return (
                     <div key={r.id} className="flex justify-between items-center py-2 border-b last:border-0">
                       <span className="font-bold text-slate-700">{r.name}</span>
                       <span className="text-red-500 font-bold bg-red-50 px-2 rounded">{m.toFixed(1)}%</span>
                     </div>
                   )
                 })}
                 {lowMarginRecipes.length === 0 && <div className="text-center text-slate-400 py-4">ç›®å‰æ‰€æœ‰å–®å“æ¯›åˆ©çš†é”æ¨™ï¼</div>}
               </div>
            </div>
          </div>
        );
      };

      return (
        <div className={`flex flex-col h-screen bg-gray-100 text-slate-900 transition-all duration-300 ${mobileMode ? 'max-w-md mx-auto border-x-4 border-slate-800 shadow-2xl rounded-xl my-4 overflow-hidden' : md('md:flex-row')}`}>
          
          {/* Mobile Top Bar */}
          {mobileMode && (
            <div className="bg-slate-900 text-white p-3 flex items-center justify-between shadow-md shrink-0 z-30">
              <button onClick={() => setIsSidebarOpen(true)} className="p-1 hover:bg-slate-800 rounded"><Menu size={24}/></button>
              <div className="font-bold flex items-center gap-2"><Calculator size={18} className="text-brand"/> SmartCost</div>
              <div className="w-8"></div>
            </div>
          )}

          <Sidebar />
          <div className="flex-1 overflow-hidden relative flex flex-col">
            {activeTab === 'dashboard' && <DashboardView />}
            {activeTab === 'vendors' && <VendorsView />}
            {activeTab === 'ingredients' && <IngredientsView />}
            {activeTab === 'recipes' && <RecipesView />}
            {activeTab === 'sets' && <SetsView />}
            {activeTab === 'projection' && <ProjectionView />}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SmartCostApp />);
  </script>
</body>
</html>
